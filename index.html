<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vite + Vue</title>
</head>

<body>
  <div id="app"></div>
  <button onclick="history.push('/')">首页</button>
  <button onclick="history.push('/list')">列表</button>
  <button onclick="history.replace('/list')">replace</button>
  <script type="module" src="/src/main.js"></script>

  <script>
    function buildState(back, current, forward, replace = false, computedScroll = false) {
      return {
        back, current, forward, replace, scroll: computedScroll ? {
          left: window.pageXOffset,
          top: window.pageYOffset
        } : null,
        position: window.history.length - 1
      }
    }

    function createCurrentLocation(base) {
      const { pathname, search, hash } = window.location;

      const hasIdx = base.indexOf("#");
      if (hasIdx > -1) {
        return base.slice(1) || "/"
      }

      return pathname + search + hash
    }

    function useHistoryStateNavigation(base) {
      // 路由系统包含: 当前的路径 当前路径下的状态
      const currentLocation = {
        value: createCurrentLocation(base),
      };

      const historyState = {
        value: window.history.state
      };
      // 第一次刷新页面 没有传递任何状态
      if (!historyState.value) {
        // 页面后退后是哪个路径 当前路径是哪个 要去哪个路径 用的是push还是replace 滚动条
        // console.log(buildState(null, currentLocation.value, null, true));
        // 需要调用浏览器的history的pushState或者replaceState
        changeLocation(currentLocation.value, buildState(null, currentLocation.value, null, true), true)
      }

      function changeLocation(to, state, replace) {
        const hasIdx = base.indexOf("#");
        let url = hasIdx > -1 ? base + to : to
        window.history[replace ? 'replaceState' : 'pushState'](state, null, url);
        historyState.value = state;
      }

      function push(to, data) {
        // 跳转前操作
        const currentState = Object.assign({}, historyState.value, {
          forward: to,
          scroll: {
            left: window.pageXOffset,
            top: window.pageYOffset
          }
        });
        changeLocation(currentState.current, currentState, true);
        // 跳转后操作
        const state = Object.assign({}, buildState(currentLocation.value, to, null), {
          position: currentState.position + 1
        }, data);
        changeLocation(to, state, false);
        currentLocation.value = to;
      }

      function replace(to, data) {
        const state = Object.assign({}, buildState(historyState.value.back, to, historyState.value.forward, true), data);
        changeLocation(to, state, true); // 同步当前路径的状态
        currentLocation.value = to; // 修改当前路径
      }

      return {
        location: currentLocation,
        state: historyState,
        push,
        replace
      }
    }

    function useHistoryListener(historyState, currentLocation) {
      let listeners = [];

      const popStateHandler = ({ state }) => {
        console.log(state)
        const to = createCurrentLocation(base);
        const from = currentLocation.value;
        const fromState = historyState.value;

        currentLocation.value = to;
        historyState.value = state;
        let isBack = state.position - fromState.position < 0;
        console.log(isBack)
        listeners.forEach(listen => {
          listen(to, from, { isBack })
        })
      };
      // 只能监听浏览器的前进后退
      window.addEventListener("popstate", popStateHandler);

      // listen 提供者用户 订阅 popstate事件 由路由系统在浏览器前进后退的时候发布
      function listen(cb) {
        listeners.push(cb)
      }

      return {
        listen
      }
    }


    function createWebHistory(base = "") {
      const historyNavigation = useHistoryStateNavigation(base);

      const historyListeners = useHistoryListener(historyNavigation.state, historyNavigation.location)

      const routerHistory = Object.assign({}, historyNavigation, historyListeners);

      Object.defineProperty(routerHistory, "location", {
        get: () => historyNavigation.location.value
      });

      Object.defineProperty(routerHistory, "state", {
        get: () => historyNavigation.state.value
      });

      return routerHistory
    }

    function createHashHistory() {
      return createWebHistory("#");
    }

    const history = createHashHistory();
    history.listen(() => {
      console.log("哈哈哈");
    })
    console.log(history)
  </script>

</body>

</html>